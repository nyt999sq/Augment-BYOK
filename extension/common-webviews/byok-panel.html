<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="{{CSP}}" />
  <title>Augment BYOK</title>
  <style>
    :root {
      --fg: var(--vscode-foreground);
      --bg: var(--vscode-editor-background);
      --muted: var(--vscode-descriptionForeground);
      --border: var(--vscode-panel-border);
      --input-bg: var(--vscode-input-background);
      --input-fg: var(--vscode-input-foreground);
      --btn-bg: var(--vscode-button-background);
      --btn-fg: var(--vscode-button-foreground);
      --btn-bg-hover: var(--vscode-button-hoverBackground);
      --error: var(--vscode-inputValidation-errorBorder);
      --warn: var(--vscode-inputValidation-warningBorder);
      --ok: var(--vscode-testing-iconPassed);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* Custom styles for a more polished look */
      --card-bg: color-mix(in srgb, var(--bg) 95%, var(--fg) 5%);
      --shadow-color: color-mix(in srgb, var(--bg) 50%, transparent);
      --accent-color: var(--vscode-button-background);
      --destructive-fg: var(--vscode-errorForeground);
    }

    body {
      margin: 0;
      padding: 24px;
      color: var(--fg);
      background: var(--bg);
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      line-height: 1.5;
    }

    .wrap {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 32px;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 22px;
      font-weight: 600;
    }

    .sub {
      margin: 0 auto;
      max-width: 640px;
      color: var(--muted);
      line-height: 1.6;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin: 16px 0;
      transition: border-color 0.2s ease-in-out;
    }

    .grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 18px 16px;
      align-items: flex-start;
    }

    label {
      color: var(--fg);
      font-weight: 500;
      padding-top: 8px;
    }

    input,
    textarea,
    select {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px 12px;
      background: var(--input-bg);
      color: var(--input-fg);
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 1px var(--accent-color);
    }

    textarea {
      min-height: 100px;
      font-family: var(--mono);
      line-height: 1.4;
    }

    .hint {
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
      margin-top: 24px;
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 8px 16px;
      background: transparent;
      color: var(--fg);
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    button:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }

    button.primary {
      background: var(--btn-bg);
      color: var(--btn-fg);
      border-color: transparent;
    }

    button.primary:hover {
      background: var(--btn-bg-hover);
    }

    button.destructive {
      color: var(--destructive-fg);
    }

    button.destructive:hover {
      background: color-mix(in srgb, var(--destructive-fg) 10%, transparent);
      border-color: var(--destructive-fg);
    }

    .status {
      margin-top: 20px;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .status.ok {
      border-color: var(--ok);
      color: var(--ok);
      background: color-mix(in srgb, var(--ok) 10%, transparent);
    }

    .status.warn {
      border-color: var(--warn);
      color: var(--warn);
      background: color-mix(in srgb, var(--warn) 10%, transparent);
    }

    .status.error {
      border-color: var(--error);
      color: var(--error);
      background: color-mix(in srgb, var(--error) 10%, transparent);
    }

    .mono {
      font-family: var(--mono);
      background: color-mix(in srgb, var(--muted) 20%, transparent);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 0.95em;
    }
  </style>
</head>

<body>
  <div class="wrap">
	    <header>
		    <h1>Augment BYOK 自定义模型配置</h1>
		    <p class="sub">配置自己的 <span class="mono">OpenAI-compatible</span> 模型端点。API Key / Augment Token 仅保存在 VS Code Secret Storage，不会写入 <span class="mono">settings.json</span> 或同步；可选配置 Augment 官方服务用于非 AI 能力回落。</p>
		  </header>

	  <div class="card">
	    <div class="grid">
	      <label for="baseUrl">API 地址</label>
		      <div>
		        <input id="baseUrl" placeholder="https://api.openai.com/v1" />
		        <div class="hint">建议填写到 <span class="mono">/v1</span>（示例：<span class="mono">https://api.openai.com/v1</span>）；如未包含 <span class="mono">/v1</span>，扩展会自动补全。</div>
		      </div>
	
	        <label for="apiKey">API 密钥 (API Key)</label>
	        <div>
	          <input id="apiKey" type="password" placeholder="留空表示不修改当前已保存的 Key" />
	          <div id="apiKeyState" class="hint">Key 状态：加载中…</div>
	        </div>
	
	        <label for="model">模型名称</label>
	        <div>
	          <input id="model" placeholder="gpt-4o-mini / gpt-4o / 您的模型名" />
	        </div>

        <label for="temperature">模型温度 (Temperature)</label>
        <div>
          <input id="temperature" type="number" step="0.01" min="0" max="2" />
        </div>

        <label for="maxTokens">最大令牌 (Max Tokens)</label>
        <div>
          <input id="maxTokens" type="number" step="1" min="1" placeholder="留空表示不强制" />
	        </div>

        <label for="enableClaudeThinking">Claude Thinking</label>
        <div>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 0;">
            <input id="enableClaudeThinking" type="checkbox" style="width: auto;" />
            <span>启用 Claude Thinking（自动注入 anthropic-beta 头和 thinking 参数）</span>
          </label>
          <div class="hint">勾选后会自动添加 thinking 相关配置，无需手动填写下方 JSON。</div>
        </div>

        <label for="thinkingBudget">Thinking Token 预算</label>
        <div>
          <input id="thinkingBudget" type="number" step="1000" min="1000" placeholder="30000" />
          <div class="hint">Claude thinking 的 token 预算，默认 30000。</div>
        </div>
	      </div>
	    </div>
	
	    <div class="card">
	      <div class="grid">
	        <label for="systemPromptBase">系统提示词 (可选)</label>
	        <div>
	          <textarea id="systemPromptBase" placeholder="留空表示使用内置默认 system prompt。"></textarea>
	          <div class="hint">会与 workspace/user guidelines 一起组合成最终的 system prompt。</div>
	        </div>
	      </div>
	    </div>

    <div class="card">
      <div class="grid">
        <label for="extraHeaders">额外请求头 (JSON)</label>
        <div>
          <textarea id="extraHeaders" placeholder='{"anthropic-beta": "interleaved-thinking-2025-05-14"}'></textarea>
          <div class="hint">JSON 格式的额外 HTTP 请求头，用于启用特殊功能（如 Anthropic thinking）。</div>
        </div>

        <label for="extraArgs">额外请求参数 (JSON)</label>
        <div>
          <textarea id="extraArgs" placeholder='{"thinking": {"type": "enabled", "budget_tokens": 30000}}'></textarea>
          <div class="hint">JSON 格式的额外请求体参数，会合并到 API 请求中（如 thinking 参数）。</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <label for="augmentBaseUrl">Augment 备用地址 (可选)</label>
        <div>
          <input id="augmentBaseUrl" placeholder="https://.../api/ 或您的 tenantURL（用于透传官方能力）" />
          <div class="hint">留空表示不透传：除 chat/completion 等 BYOK 端点外，其它请求也会走本地适配器（可能导致 UI 功能不全）。</div>
        </div>

        <label for="augmentToken">Augment 备用密钥 (可选)</label>
        <div>
          <input id="augmentToken" type="password" placeholder="留空表示不修改当前已保存的 Token" />
          <div id="augmentTokenState" class="hint">Token 状态：加载中…</div>
        </div>
      </div>
    </div>

    <div class="row">
      <button id="reloadBtn">刷新</button>
      <button id="clearKeyBtn" class="destructive">清除密钥</button>
      <button id="clearAugmentTokenBtn" class="destructive">清除备用密钥</button>
      <button id="saveBtn" class="primary">保存配置</button>
    </div>

    <div id="status" class="status">等待配置加载…</div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    const el = (id) => document.getElementById(id);
    const baseUrlEl = el("baseUrl");
    const modelEl = el("model");
    const temperatureEl = el("temperature");
    const maxTokensEl = el("maxTokens");
    const apiKeyEl = el("apiKey");
    const apiKeyStateEl = el("apiKeyState");
    const systemPromptBaseEl = el("systemPromptBase");
    const augmentBaseUrlEl = el("augmentBaseUrl");
    const augmentTokenEl = el("augmentToken");
    const augmentTokenStateEl = el("augmentTokenState");
    const extraHeadersEl = el("extraHeaders");
    const extraArgsEl = el("extraArgs");
    const enableClaudeThinkingEl = el("enableClaudeThinking");
    const thinkingBudgetEl = el("thinkingBudget");
	    const statusEl = el("status");

    function setStatus(text, kind) {
      statusEl.textContent = text;
      statusEl.className = "status" + (kind ? " " + kind : "");
    }

    function readNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : null;
    }

	    function requestConfig() {
	      vscode.postMessage({ type: "byok.getConfig" });
	      setStatus("正在加载配置…", "");
	    }

	    function saveConfig({ clearApiKey, clearAugmentToken }) {
	      const baseUrl = String(baseUrlEl.value || "").trim();
	      const model = String(modelEl.value || "").trim();
	      const temperature = readNumber(temperatureEl.value);
	      const maxTokens = readNumber(maxTokensEl.value);
	      const systemPromptBase = String(systemPromptBaseEl.value || "");

      const apiKey = String(apiKeyEl.value || "");
      const augmentBaseUrl = String(augmentBaseUrlEl.value || "").trim();
      const augmentToken = String(augmentTokenEl.value || "");
      
      // Parse extraHeaders and extraArgs as JSON
      let extraHeaders = {};
      let extraArgs = {};
      try {
        const extraHeadersRaw = String(extraHeadersEl.value || "").trim();
        if (extraHeadersRaw) extraHeaders = JSON.parse(extraHeadersRaw);
      } catch (e) {
        setStatus("extraHeaders JSON 格式错误: " + e.message, "error");
        return;
      }
      try {
        const extraArgsRaw = String(extraArgsEl.value || "").trim();
        if (extraArgsRaw) extraArgs = JSON.parse(extraArgsRaw);
      } catch (e) {
        setStatus("extraArgs JSON 格式错误: " + e.message, "error");
        return;
      }
      
      // Handle Claude Thinking toggle
      const enableClaudeThinking = enableClaudeThinkingEl.checked;
      const thinkingBudget = readNumber(thinkingBudgetEl.value) || 30000;
      if (enableClaudeThinking) {
        extraHeaders["anthropic-beta"] = "interleaved-thinking-2025-05-14";
        extraArgs["thinking"] = { type: "enabled", budget_tokens: thinkingBudget };
      }
      
      const payload = {
        baseUrl,
        model,
        temperature: temperature === null ? 0.2 : temperature,
        maxTokens: maxTokens === null ? undefined : maxTokens,
        systemPromptBase,
        clearApiKey: Boolean(clearApiKey),
        augmentBaseUrl,
        clearAugmentToken: Boolean(clearAugmentToken),
        extraHeaders,
        extraArgs,
      };
      if (!clearApiKey && apiKey.trim()) payload.apiKey = apiKey;
      if (!clearAugmentToken && augmentToken.trim()) payload.augmentToken = augmentToken;

      vscode.postMessage({ type: "byok.saveConfig", config: payload });
      setStatus("正在保存…", "");
    }

    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== "object") return;

      if (msg.type === "byok.config" && msg.config) {
        const c = msg.config;
        baseUrlEl.value = c.baseUrl || "";
        modelEl.value = c.model || "";
        temperatureEl.value = typeof c.temperature === "number" ? String(c.temperature) : "0.2";
        maxTokensEl.value = typeof c.maxTokens === "number" ? String(c.maxTokens) : "";
        systemPromptBaseEl.value = c.systemPromptBase || "";
        apiKeyEl.value = "";
        apiKeyStateEl.textContent = "Key 状态：" + (c.apiKeySet ? "已保存（不会回显）" : "未保存");
        augmentBaseUrlEl.value = c.augmentBaseUrl || "";
        augmentTokenEl.value = "";
        augmentTokenStateEl.textContent = "Token 状态：" + (c.augmentTokenSet ? "已保存（不会回显）" : "未保存");
        
        // Detect Claude Thinking from saved config
        const hasThinkingHeader = c.extraHeaders && c.extraHeaders["anthropic-beta"] === "interleaved-thinking-2025-05-14";
        const hasThinkingArg = c.extraArgs && c.extraArgs.thinking && c.extraArgs.thinking.type === "enabled";
        enableClaudeThinkingEl.checked = hasThinkingHeader && hasThinkingArg;
        thinkingBudgetEl.value = (c.extraArgs && c.extraArgs.thinking && c.extraArgs.thinking.budget_tokens) || "";
        
        // Show extraHeaders/extraArgs without the Claude Thinking parts (for advanced users)
        const displayHeaders = { ...c.extraHeaders };
        const displayArgs = { ...c.extraArgs };
        if (hasThinkingHeader) delete displayHeaders["anthropic-beta"];
        if (hasThinkingArg) delete displayArgs["thinking"];
        extraHeadersEl.value = Object.keys(displayHeaders).length > 0 ? JSON.stringify(displayHeaders, null, 2) : "";
        extraArgsEl.value = Object.keys(displayArgs).length > 0 ? JSON.stringify(displayArgs, null, 2) : "";
        
        setStatus("配置已加载", c.apiKeySet ? "ok" : "warn");
        return;
      }

	      if (msg.type === "byok.saved") return setStatus(msg.ok ? "已保存" : "保存失败：" + (msg.error || "未知错误"), msg.ok ? "ok" : "error");
	    });

    el("reloadBtn").addEventListener("click", () => requestConfig());
    el("saveBtn").addEventListener("click", () => saveConfig({ clearApiKey: false, clearAugmentToken: false }));
    el("clearKeyBtn").addEventListener("click", () => saveConfig({ clearApiKey: true, clearAugmentToken: false }));
    el("clearAugmentTokenBtn").addEventListener("click", () => saveConfig({ clearApiKey: false, clearAugmentToken: true }));

    requestConfig();
  </script>
</body>

</html>
